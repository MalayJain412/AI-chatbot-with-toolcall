name: Deploy FastAPI App

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy & Restart App on VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e

            APP_DIR="${{ secrets.APP_DIR }}"
            VENV="$APP_DIR/venv"
            PM2_NAME="chatbot-app"

            echo ">>> Switching to app dir"
            cd $APP_DIR

            echo ">>> Pull latest from prod"
            git fetch origin
            git checkout prod
            git pull origin prod

            echo ">>> Create venv if missing"
            if [ ! -d "$VENV" ]; then
              python3 -m venv $VENV
            fi

            echo ">>> Activate venv"
            source $VENV/bin/activate

            echo ">>> Install dependencies"
            pip install -r requirements.txt

            echo ">>> Restarting PM2"
            pm2 restart "$PM2_NAME" \
              || pm2 start $VENV/bin/uvicorn --name "$PM2_NAME" -- main:app --host 0.0.0.0 --port 8000 --workers 4

            echo ">>> Saving PM2 startup"
            pm2 save

            echo ">>> Deployment complete ğŸ‰"
